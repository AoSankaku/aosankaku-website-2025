---
// Blog article list page (/blog/)
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getCollection } from "astro:content";

import { useTranslator } from "@/i18n/utils";
import { type Lang } from "@/types/i18n";

const allPosts = await getCollection("blog");

const t = useTranslator(Astro.currentLocale as Lang);
---

<Layout title={t("blog.all-articles")}>
  <Header />
  <div>
    <h1>{t("blog.all-articles")}</h1>
    <p>{t("blog.search-articles")}</p>
    <input
      type="text"
      id="searchInput"
      placeholder="タイトルから記事を検索..."
      style="width: 100%; padding: 8px; margin-bottom: 16px; box-sizing: border-box;"
    />
    <ul>
      {
        allPosts
          .toSorted((a: any, b: any) => {
            const dateA = new Date(a.data.lastUpdate ?? a.data.date);
            const dateB = new Date(b.data.lastUpdate ?? b.data.date);
            return dateB.getTime() - dateA.getTime();
          })
          .map((post) => (
            <li>
              <a href={`/blog/${post.id.replace(/\/index$/, "")}/`}>
                {post.data.title}
              </a>
            </li>
          ))
      }
    </ul>
  </div>
  <Footer />
</Layout>

<style>
  div {
    margin: 80px max(20px, 5%);
  }
</style>

<script>
  import "../../utils/prototypes";

  const searchInput = document.getElementById(
    "searchInput",
  ) as HTMLInputElement;
  const postList = document.querySelectorAll("ul li");

  const filterArticles = () => {
    const value = searchInput.value;
    // Save to session storage so it survives navigation
    sessionStorage.setItem("blog-search-query", value);

    const filter = value.toLowerCase().toKatakana();

    postList.forEach((post) => {
      const postElement = post as HTMLElement;
      const title = postElement.textContent?.toLowerCase().toKatakana() || "";

      postElement.style.display = title.includes(filter) ? "" : "none";
    });
  };

  // 1. Restore value from sessionStorage on load
  const savedSearch = sessionStorage.getItem("blog-search-query");
  if (savedSearch !== null) {
    searchInput.value = savedSearch;
  }

  // 2. Initial run to sync list with the restored value
  filterArticles();

  // 3. Listen for changes
  searchInput.addEventListener("input", filterArticles);

  // 4. Handle "pageshow" (Required for Safari and some browsers when using 'Back')
  window.addEventListener("pageshow", (event) => {
    // If the page was loaded from the 'bfcache' (back-forward cache)
    if (event.persisted) {
      filterArticles();
    }
  });
</script>
