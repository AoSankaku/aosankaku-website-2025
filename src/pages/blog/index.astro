---
// Blog article list page (/blog/)
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";

import { useTranslator } from "@/i18n/utils";
import { type Lang } from "@/types/i18n";

const allPosts = await getCollection("blog");
// 1. Calculate tag occurrences
const tagCountMap: Record<string, number> = {};
allPosts.forEach((post) => {
  post.data.tags?.forEach((tag: string) => {
    tagCountMap[tag] = (tagCountMap[tag] || 0) + 1;
  });
});

// 2. Sort tags by occurrence (descending), then alphabetically
const sortedTags = Object.keys(tagCountMap).sort((a, b) => {
  const countDiff = tagCountMap[b] - tagCountMap[a];
  return countDiff !== 0 ? countDiff : a.localeCompare(b);
});

const t = useTranslator(Astro.currentLocale as Lang);
---

<Layout title={t("blog.all-articles")}>
  <Header />
  <div>
    <h1>{t("blog.all-articles")}</h1>

    <p>{t("blog.search-articles")}</p>
    <input
      type="text"
      id="searchInput"
      placeholder="タイトルから記事を検索..."
      style="width: 100%; padding: 8px; margin-bottom: 8px; box-sizing: border-box;"
    />

    <div id="tagFilters">
      {
        sortedTags.map((tag) => (
          <button class="tag-button" data-tag={tag}>
            #{tag} <span class="tag-count">({tagCountMap[tag]})</span>
          </button>
        ))
      }
      {
        sortedTags.length > 0 && (
          <button id="clearTags">
            <Icon name="mdi:trash" size="1.4em" /> Clear all
          </button>
        )
      }
    </div>

    <ul>
      {
        allPosts
          .toSorted((a: any, b: any) => {
            const dateA = new Date(a.data.lastUpdate ?? a.data.date);
            const dateB = new Date(b.data.lastUpdate ?? b.data.date);
            return dateB.getTime() - dateA.getTime();
          })
          .map((post) => (
            // Add tags to data-attribute as a string
            <li data-tags={(post.data.tags || []).join(",")}>
              <a href={`/blog/${post.id.replace(/\/index$/, "")}/`}>
                {post.data.title}
              </a>
            </li>
          ))
      }
    </ul>

    <div id="nothingFound">
      <Icon name="twemoji:person-shrugging" size="64px" />
      <p>
        何も見つからなかったらしい。<br
        />タグを消したりキーワードを変えたりしてみてね。
      </p>
    </div>
  </div>
  <Footer />
</Layout>

<style>
  div {
    margin: 80px max(20px, 5%);
  }

  #tagFilters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 24px 0 64px 0;
  }

  #clearTags {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.8em;
    color: var(--color-text-sub);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
  }

  .tag-button {
    padding: 4px 12px;
    border-radius: 16px;
    border: 2px solid var(--color-text-sub);
    background: transparent;
    cursor: pointer;
    font-size: 0.85em;
    color: var(--color-text);
    height: 32px;
  }

  .tag-count {
    color: var(--color-text-sub);
    font-size: 0.9em;
  }

  .tag-button.active {
    background: var(--color-primary);
    color: var(--color-background);
    border-color: var(--color-text-sub);
  }

  #nothingFound {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
</style>

<script>
  import "../../utils/prototypes";

  const searchInput = document.getElementById(
    "searchInput",
  ) as HTMLInputElement;
  const tagButtons = document.querySelectorAll(".tag-button");
  const clearBtn = document.getElementById("clearTags");
  const postList = document.querySelectorAll("ul li");
  let hasVisible = false;

  let activeTags: string[] = JSON.parse(
    sessionStorage.getItem("blog-active-tags") || "[]",
  );

  const filterArticles = () => {
    hasVisible = false;
    const searchText = searchInput.value.toLowerCase().toKatakana();
    sessionStorage.setItem("blog-search-query", searchInput.value);
    sessionStorage.setItem("blog-active-tags", JSON.stringify(activeTags));
    const nothingFound = document.getElementById("nothingFound");

    tagButtons.forEach((btn) => {
      const tag = (btn as HTMLElement).dataset.tag || "";
      btn.classList.toggle("active", activeTags.includes(tag));
    });

    postList.forEach((post) => {
      const postElement = post as HTMLElement;
      const title = postElement.textContent?.toLowerCase().toKatakana() || "";
      const postTags = postElement.dataset.tags?.split(",") || [];

      const matchesSearch = title.includes(searchText);
      const matchesTags =
        activeTags.length === 0 ||
        activeTags.every((tag) => postTags.includes(tag));

      postElement.style.display = matchesSearch && matchesTags ? "" : "none";
      if (matchesSearch && matchesTags) {
        hasVisible = true;
      }
    });
    nothingFound?.style.setProperty("display", hasVisible ? "none" : "flex");
  };

  searchInput.addEventListener("input", filterArticles);

  tagButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tag = (btn as HTMLElement).dataset.tag || "";
      if (activeTags.includes(tag)) {
        activeTags = activeTags.filter((t) => t !== tag);
      } else {
        activeTags.push(tag);
      }
      filterArticles();
    });
  });

  clearBtn?.addEventListener("click", () => {
    activeTags = [];
    searchInput.value = ""; // Optional: Clear search too
    filterArticles();
  });

  // Init
  const savedSearch = sessionStorage.getItem("blog-search-query");
  if (savedSearch !== null) searchInput.value = savedSearch;

  filterArticles();

  window.addEventListener("pageshow", (event) => {
    if (event.persisted) filterArticles();
  });
</script>
