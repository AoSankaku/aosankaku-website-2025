---
import Layout from "./Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { Image } from "astro:assets";
import formatToJSTDate from "@/utils/formatToJSTDate";
import { Icon } from "astro-icon/components";
import type { MarkdownHeading } from "astro";
import { getIcon } from "@/consts/categoryIcons";
import ShareButtons from "@/components/ShareButtons.astro";
import RelatedArticles from "@/components/atoms/RelatedArticles.astro";
import "remark-github-alerts/styles/github-base.css";
import "@/styles/blogArticleStyle.css";
import getArticleImage from "@/utils/getArticleImage";

interface Props {
  frontmatter: any;
  headings: MarkdownHeading[];
  slug: string;
}

const { frontmatter, headings, slug } = Astro.props;

// IMPORTANT TO-DO: this can't handle non-blog article thumbnail at all
const articleImage = getArticleImage(slug, frontmatter.thumbnail);

const articleDate = formatToJSTDate(frontmatter.date);
const lastUpdate = frontmatter.lastUpdate
  ? formatToJSTDate(frontmatter.lastUpdate)
  : null;

// TOC generation

const toc = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

<Layout
  title={frontmatter.title}
  description={frontmatter.desc}
  type="article"
  ogpImage={articleImage}
>
  <Header />
  <div class="blog-hero">
    <Image src={articleImage} alt={frontmatter.alt || ""} loading="eager" />
    <p class="category">
      <Icon name={getIcon(frontmatter.category)} size="1.2em" />{
        frontmatter.category
      }
    </p>
    <h1>{frontmatter.title}</h1>
    <p class="desc">{frontmatter.desc}</p>
    <div class="date-container">
      <Icon name="mdi:calendar" size="1.1em" /><p class="date">{articleDate}</p>
      {
        lastUpdate && (
          <>
            <Icon name="mdi:update" size="1.1em" />
            <p class="date">{lastUpdate}</p>
          </>
        )
      }
    </div>
  </div>
  <div class="container">
    <slot />
  </div>
  <RelatedArticles slug={slug} />

  {
    frontmatter.tags && (
      <div class="tags">
        <h3>記事のタグ</h3>
        {frontmatter.tags.map((tag: string) => (
          <span class="tag">
            <Icon name="mdi:tag" size="0.8em" />
            {tag}
          </span>
        ))}
      </div>
    )
  }
  <ShareButtons title={frontmatter.title} />
  <Footer />
</Layout>

<script is:inline define:vars={{ toc }}>
  const container = document.getElementById("article-toc-trigger");
  if (container && toc.length > 0) {
    const title = document.createElement("h2");
    title.innerText = "Table of Contents";

    const list = document.createElement("ul");
    toc.forEach((h) => {
      const li = document.createElement("li");
      li.style.marginLeft = `${(h.depth - 2) * 20}px`;
      const a = document.createElement("a");
      a.href = `#${h.slug}`;

      // --- Emoji Integration ---
      // Find the actual heading in the article using the slug
      const actualHeading = document.getElementById(h.slug);
      if (actualHeading) {
        // Clone content to remove any nested anchor links (#)
        const clone = actualHeading.cloneNode(true);
        clone.querySelectorAll("a, .anchor-link").forEach((el) => el.remove());
        // Set HTML to preserve the <img> tags from twemoji
        a.innerHTML = clone.innerHTML;
      } else {
        a.innerText = h.text; // Fallback to plain text
      }
      // -------------------------

      li.appendChild(a);
      list.appendChild(li);
    });

    container.appendChild(title);
    container.appendChild(list);
  }
</script>
